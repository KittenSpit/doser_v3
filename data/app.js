async function api(path, opts){ let r = await fetch(path, opts); if(!r.ok) throw new Error('api err'); let ct = r.headers.get('content-type')||''; if(ct.indexOf('application/json')>=0) return r.json(); return r.text(); }
async function refreshDashboard(){ try{ let s = await api('/status'); document.getElementById('ip').innerText = 'IP: '+s.ip; let sel = document.getElementById('pumpsel'); let sel2 = document.getElementById('calpump'); sel.innerHTML=''; if(sel2) sel2.innerHTML=''; let html = '<table><tr><th>ID</th><th>Status</th><th>Remaining</th><th>Duty</th><th>ml/s</th><th>delivered</th></tr>'; s.pumps.forEach(p=>{ html += `<tr><td>${p.idx}</td><td>${p.running?'RUN':'OFF'}</td><td>${p.remaining_ms}</td><td>${p.duty}</td><td>${Number(p.ml_per_sec).toFixed(4)}</td><td>${Number(p.delivered_ml).toFixed(3)}</td></tr>`; sel.innerHTML += `<option value="${p.idx}">Pump ${p.idx}</option>`; if(sel2) sel2.innerHTML += `<option value="${p.idx}">Pump ${p.idx}</option>`; }); html += '</table>'; document.getElementById('pumps').innerHTML = html; let schHtml = '<table><tr><th>#</th><th>En</th><th>Pump</th><th>Time</th><th>ml</th><th>Save</th></tr>'; s.schedules.forEach(sc=>{ schHtml += `<tr><td>${sc.idx}</td><td><input id="e${sc.idx}" type="checkbox" ${sc.enabled?'checked':''}></td><td><input id="p${sc.idx}" type="number" value="${sc.pump}" style="width:60px;"></td><td><input id="t${sc.idx}" type="time" value="${('0'+sc.hour).slice(-2)}:${('0'+sc.minute).slice(-2)}"></td><td><input id="m${sc.idx}" type="number" value="${sc.ml.toFixed(2)}" step="0.1" style="width:80px;"></td><td><button onclick="saveSch(${sc.idx})">Save</button></td></tr>`; }); schHtml += '</table>'; let sdiv = document.getElementById('schedules'); if(sdiv) sdiv.innerHTML = schHtml; let logsDiv = document.getElementById('logs'); if(logsDiv){ logsDiv.innerHTML=''; s.logs.forEach(e=>{ logsDiv.innerHTML += `<div>[${e.ts}] <b>${e.event}</b> - ${e.msg}</div>`; }); } }catch(e){ console.error(e); } }
async function start(){ let i=document.getElementById('pumpsel').value; let s=document.getElementById('secs').value; let p=document.getElementById('pwr').value; await api(`/start?i=${i}&s=${s}&p=${p}`); refreshDashboard(); }
async function stop(){ let i=document.getElementById('pumpsel').value; await api(`/stop?i=${i}`); refreshDashboard(); }
async function prime(){ let i=document.getElementById('pumpsel').value; let s=document.getElementById('secs').value; let p=document.getElementById('pwr').value; await api(`/prime?i=${i}&s=${s}&p=${p}`); refreshDashboard(); }
async function purge(){ let i=document.getElementById('pumpsel').value; let s=document.getElementById('secs').value; let p=document.getElementById('pwr').value; await api(`/purge?i=${i}&s=${s}&p=${p}`); refreshDashboard(); }
async function calibrate(){ let idx=document.getElementById('calpump').value; let ml=document.getElementById('ml').value; let s=document.getElementById('runsec').value; await api(`/calibrate?i=${idx}&ml=${ml}&s=${s}`); document.getElementById('msg').innerText='calibrated'; refreshDashboard(); }
async function saveSch(idx){ let en = document.getElementById('e'+idx).checked?1:0; let pump=document.getElementById('p'+idx).value; let time=document.getElementById('t'+idx).value; let ml=document.getElementById('m'+idx).value; await api('/schedules?idx='+idx+'&enabled='+en+'&pump='+pump+'&time='+encodeURIComponent(time)+'&ml='+ml, { method:'POST' }); refreshDashboard(); }
setInterval(refreshDashboard,3000); window.onload = refreshDashboard;
